<section class="profile-page">
  <h1 class="profile-title">Mi perfil</h1>

  <div class="profile-layout">
    <!-- PERFIL -->
    <div class="card">
      <form [formGroup]="profileForm" (submit)="onSubmit()" class="form">
        <div class="toolbar">
          @if (isEditing) {
            <button
              class="btn secondary"
              type="button"
              (click)="toggleEdit()"
              [disabled]="isSubmitting"
            >
              Cancelar
            </button>

            <button
              class="btn primary"
              type="submit"
              [disabled]="profileForm.invalid || isSubmitting"
            >
              @if (isSubmitting) {
                <app-spinner />
              } @else {
                Guardar cambios <mat-icon fontIcon="save" />
              }
            </button>
          } @else {
            <button class="btn outline" type="button" (click)="toggleEdit()">
              Modificar perfil <mat-icon fontIcon="edit" />
            </button>
          }
        </div>

        <fieldset class="fieldset">
          <legend>Datos personales</legend>
          <div class="grid-2">
            <!-- Usamos siempre par-form-field para RUN; el componente TS pone el valor
                 formateado cuando el form está en modo lectura y raw cuando se entra a editar -->
            <par-form-field [formCtrl]="fc('run')" format="run" label="RUN" />

            <par-form-field
              [formCtrl]="fc('documentNumber')"
              label="Número de documento"
            />
            <par-form-field [formCtrl]="fc('names')" label="Nombres" />
            <par-form-field
              [formCtrl]="fc('firstLastName')"
              label="Primer apellido"
            />
            <par-form-field
              [formCtrl]="fc('secondLastName')"
              label="Segundo apellido"
            />
          </div>
        </fieldset>

        <fieldset class="fieldset">
          <legend>Información de contacto</legend>
          <div class="grid-2">
            <par-form-field [formCtrl]="fc('email')" label="Correo electrónico" />
            <par-form-field [formCtrl]="fc('cellphone')" label="Teléfono" />
          </div>
        </fieldset>

        <fieldset class="fieldset">
          <legend>Dirección</legend>
          <div class="grid-2">
            <par-form-field [formCtrl]="fc('street')" label="Calle" />
            <par-form-field [formCtrl]="fc('number')" label="Número" />
            <par-form-field [formCtrl]="fc('detail')" label="Detalle" />

            <mat-form-field appearance="outline">
              <mat-label>Región</mat-label>
              <mat-select [formControl]="fc('regionId')">
                <mat-option [value]="0">Seleccione región</mat-option>
                <mat-option
                  *ngFor="let r of (regions$ | async) ?? []"
                  [value]="r.id"
                >
                  {{ r.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Comuna</mat-label>
              <mat-select [formControl]="fc('communeId')">
                <mat-option [value]="0">Seleccione comuna</mat-option>
                <mat-option
                  *ngFor="let c of (communes$ | async) ?? []"
                  [value]="c.id"
                >
                  {{ c.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </fieldset>
      </form>
    </div>

    <!-- CUENTA BANCARIA -->
    <div class="card bank-card">
      <div class="card-head">
        <h2 class="card-title">Cuenta bancaria</h2>

        <div class="card-actions">
          @if (!bankEditing && bankHasAccount) {
            <button class="btn outline" type="button" (click)="toggleBankEdit()">
              Editar <mat-icon fontIcon="edit" />
            </button>
          } @else if (bankEditing && bankHasAccount) {
            <button
              class="btn secondary"
              type="button"
              (click)="toggleBankEdit()"
              [disabled]="bankSaving"
            >
              Cancelar
            </button>
          }
        </div>
      </div>

      @if (bankLoading) {
        <div class="state"><app-spinner /></div>
      } @else {
        @if (bankError) {
          <div class="alert error">{{ bankError }}</div>
        }
        @if (bankSuccess) {
          <div class="alert success">{{ bankSuccess }}</div>
        }

        <form [formGroup]="bankForm" class="form">
          <div class="hint">
            @if (bankHasAccount) {
              La cuenta está en modo lectura. Presiona “Editar” para modificar.
            } @else {
              No tienes cuenta registrada. Completa los datos para guardarla.
            }
          </div>

          <div class="grid-2">
            <par-form-field
              [formCtrl]="bankFc('rutOwner')"
              label="RUT titular (con DV)"
            />
            <par-form-field
              [formCtrl]="bankFc('bankCode')"
              label="Banco (código)"
            />
            <par-form-field
              [formCtrl]="bankFc('bankName')"
              label="Banco (nombre)"
            />
            <par-form-field
              [formCtrl]="bankFc('accountType')"
              label="Tipo de cuenta"
            />
            <par-form-field
              [formCtrl]="bankFc('accountNumber')"
              label="Número de cuenta"
            />
            <par-form-field [formCtrl]="bankFc('email')" label="Email (opcional)" />
          </div>

          @if (bankEditing || !bankHasAccount) {
            <div class="toolbar end">
              <button
                class="btn primary wide"
                type="button"
                (click)="saveBankAccount()"
                [disabled]="bankForm.invalid || bankSaving"
              >
                @if (bankSaving) {
                  <app-spinner />
                } @else {
                  Guardar cuenta <mat-icon fontIcon="save" />
                }
              </button>
            </div>
          }
        </form>
      }
    </div>
  </div>
</section>
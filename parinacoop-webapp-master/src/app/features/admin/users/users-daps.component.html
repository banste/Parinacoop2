<section class="users-daps-container max-w-[1100px] mx-auto px-4 py-6">
  <div class="mb-6">
    <a routerLink="/admin/users" class="text-sm text-primary-600 hover:underline">← Volver a usuarios</a>
    <h1 class="text-2xl font-semibold mt-3">Depósitos a plazo</h1>
    <div class="text-sm text-gray-600">Depósitos del usuario: {{ userName }} (RUN: {{ userRun }})</div>
  </div>

  <ng-container *ngIf="daps$ | async as daps; else loadingDaps">
    <ng-container *ngIf="daps?.length; else empty">
      <div class="space-y-4">
        <ng-container *ngFor="let dap of daps; trackBy: trackById">
          <article class="dap-card">
            <div class="dap-main">
              <header class="dap-header">
                <div class="dap-title">
                  <div class="muted small">Depósito a Plazo</div>

                  <!-- row with ID and operation (internalId) -->
                  <div class="id-row">
                    <div class="id">Nº {{ dap.id }}</div>

                    <!-- Número de operación: muestra internalId al lado derecho del número -->
                    <div class="operation">
                      <div class="op-label muted small">Número de operación</div>
                      <div class="op-value">{{ dap.internalId ?? '-' }}</div>
                    </div>
                  </div>
                </div>

                <nav class="dap-links">
                  <a class="link" (click)="openDetail(dap)">Ver detalle</a>
                  <span class="dot">•</span>
                  <a class="link" (click)="openAttachments(dap)">Adjuntos</a>
                </nav>
              </header>

              <div class="dap-info">
                <div class="info-cell">
                  <div class="muted small">Tipo</div>
                  <div class="value">{{ dap.type ?? '-' }}</div>
                </div>

                <div class="info-cell">
                  <div class="muted small">Vencimiento</div>
                  <div class="value">{{ dap.dueDate ? (dap.dueDate | date:'dd-MM-yyyy') : '-' }}</div>
                </div>

                <div class="info-cell">
                  <div class="muted small">Monto a recibir</div>
                  <div class="value">${{ dap.finalAmount | number:'1.0-0' }}</div>
                </div>

                <div class="info-cell">
                  <div class="muted small">Estado</div>
                  <div
                    class="value status-badge"
                    [ngClass]="{
                      'status-active': (dap.status?.toString()?.toLowerCase() === 'active') || (dap.status?.toString()?.toLowerCase() === 'paid'),
                      'status-pending': dap.status?.toString()?.toLowerCase() === 'pending' || dap.status?.toString()?.toLowerCase() === 'expired-pending',
                      'status-expired': dap.status?.toString()?.toLowerCase() === 'expired'
                    }"
                  >
                    {{ dap.status }}
                  </div>
                </div>

                <div class="info-cell">
                  <div class="muted small">Plazo (días)</div>
                  <div class="value">{{ dap.days ?? '-' }}</div>
                </div>
              </div>
            </div>

            <aside class="dap-controls">
              <input
                #internalInput
                type="text"
                class="dap-input"
                placeholder="ID interna del DAP"
                aria-label="ID interna del DAP"
              />

              <button
                class="dap-activate-btn"
                (click)="activateByInternalId(dap, internalInput.value)"
                [disabled]="isActivatingMap[dap.id]"
              >
                <span class="material-icons icon-bolt" aria-hidden="true">bolt</span>
                <span>{{ isActivatingMap[dap.id] ? 'Activando...' : 'Activar' }}</span>
              </button>

              <div *ngIf="activationMsgMap[dap.id]" class="msg ok">{{ activationMsgMap[dap.id] }}</div>
              <div *ngIf="activationErrMap[dap.id]" class="msg err">{{ activationErrMap[dap.id] }}</div>
            </aside>
          </article>
        </ng-container>
      </div>
    </ng-container>
  </ng-container>

  <ng-template #loadingDaps>
    <div class="text-center py-8">Cargando depósitos...</div>
  </ng-template>

  <ng-template #empty>
    <div class="text-center py-8">No se encontraron depósitos para este usuario</div>
  </ng-template>
</section>